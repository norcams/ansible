---
#
# Deploy himlarcli to hosts under himlarcli_path
# Verified: This will run under ansible 2.1
#
# sudo ansible-playbook -e "myhosts=bgo-login:bgo-master" lib/himlarcli.yaml
#
- hosts: "{{ myhosts }}"
  tasks:
    - name: Install packages needed to run himlarcli on host
      yum:
        name: "{{ packages }}"
        state: installed
      vars:
        packages:
          - git
          - python-virtualenv
          - gcc
          - openldap-devel
          - openssl-devel
          - PyYAML
          - libffi-devel

    - name: "Update {{ himlarcli_repo }} with version {{ himlarcli_ref }}"
      git:
        repo: "{{ himlarcli_repo }}"
        version: "{{ himlarcli_ref }}"
        dest: "{{ himlarcli_path }}"
        force: "{{ himlarcli_force_update }}"

    - name: Manually create the initial virtualenv for himlarcli
      command: "virtualenv --clear {{ himlarcli_path }}"
      args:
        creates: "{{ himlarcli_path }}/bin/activate"

    - name: Upgrade pip
      pip:
        name: pip
        state: latest
        virtualenv: "{{ himlarcli_path }}"

    - name: Update setuptools
      pip:
        name: setuptools
        state: latest
        virtualenv: "{{ himlarcli_path }}"

    - name: Install python modules with pip
      pip:
        requirements: "{{ himlarcli_path }}/requirements.txt"
        virtualenv: "{{ himlarcli_path }}"

    - name: Run setup.py if himlarcli package is not setup
      command: bin/python setup.py develop
      args:
        chdir: "{{ himlarcli_path }}"
        creates: "{{ himlarcli_path }}/himlarcli.egg-info"

    - name: Copy config.ini from remote host
      fetch:
        src: /etc/himlarcli/config.ini
        dest: "{{ himlarcli_path }}/config.ini.{{ location }}"
        flat: yes
      when: '("login" not in inventory_hostname) and location != "vagrant"'

    # - name: Run test/deploy.sh
    #   command: "{{himlarcli_path}}/tests/deploy.sh"

    - name: Copy user whitelist from /opt/repo
      copy:
        src: /opt/repo/secrets/common/whitelist_users.txt
        dest: "{{ himlarcli_path }}/whitelist_users.txt"
        mode: '644'

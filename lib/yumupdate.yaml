#
# Upgrade one or more hosts via yum. Also runs puppet agent on the
# host, with the exception of the admin host
#
# Example 1: Normal upgrade
#   ansible-playbook -e 'myhosts=vagrant-dns,vagrant-identity' lib/yumupdate.yaml
#
# Example 2: Upgrade while excluding package
#   ansible-playbook -e 'myhosts=vagrant-dns,vagrant-identity exclude=httpd*,MariaDB*' lib/yumupdate.yaml
#
---
- hosts: "{{ myhosts }}"
  user: iaas
  gather_facts: False
  tasks:

  - name: Upgrade all packages excluding {{ exclude }}
    yum:
      name: '*'
      state: latest
      update_cache: yes
      exclude: "{{ exclude }}"
    when: exclude is defined

  - name: Upgrade all packages
    yum:
      name: '*'
      state: latest
      update_cache: yes
    when: exclude is not defined

  - name: Run puppet agent and fail if anything goes wrong
    puppet:
    when:
    - '"admin" not in inventory_hostname'
    - location != "vagrant"

  - name: Run Puppet via himlar/provision/puppetrun.sh
    command: /opt/himlar/provision/puppetrun.sh
    when:
    - '"admin" in inventory_hostname'
    - location != "vagrant"
